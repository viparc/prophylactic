---
title: "Prophylactic use"
csl: the-american-naturalist.csl
output:
  html_document:
    theme: cerulean
    toc: yes
  pdf_document:
    toc: yes
<!-- bibliography: references.bib -->
editor_options: 
  chunk_output_type: console
---

<!--
IMAGES:
Insert them with: ![alt text](image.png)
You can also resize them if needed: convert image.png -resize 50% image.png
If you want to center the image, go through HTML code:
<div style="text-align:center"><img src ="image.png"/></div>

REFERENCES:
For references: Put all the bibTeX references in the file "references.bib"
in the current folder and cite the references as @key or [@key] in the text.
Uncomment the bibliography field in the above header and put a "References"
title wherever you want to display the reference list.
-->

<style type="text/css">
.main-container {
  max-width: 1370px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r general_options, include = FALSE}
knitr::knit_hooks$set(
  margin = function(before, options, envir) {
    if (before) par(mgp = c(1.5, .5, 0), bty = "n", plt = c(.105, .97, .13, .97))
    else NULL
  },
  prompt = function(before, options, envir) {
    options(prompt = if (options$engine %in% c("sh", "bash")) "$ " else "> ")
  })

knitr::opts_chunk$set(margin = TRUE, prompt = TRUE, comment = "",
                      collapse = TRUE, cache = FALSE, autodep = TRUE,
                      dev.args = list(pointsize = 11), fig.height = 3.5,
                      fig.width = 4.24725, fig.retina = 2, fig.align = "center")

options(width = 137)
```

## Packages

Installing the required packages:

```{r}
required <- c("dplyr", "magrittr", "purrr", "readr")
to_install <- setdiff(required, row.names(installed.packages()))
if (length(to_install)) install.packages(to_install)
```

Loading `magrittr`:

```{r}
library(magrittr)
```

## Loading the data

```{r}
viparc <- readr::read_csv("https://raw.githubusercontent.com/viparc/prophylactic/master/data/viparc_qualitative.csv",
                          col_types = paste(c("cii", rep("l", 51)), collapse = ""))
```

We have 3 types of variables in this data frame:

* week ID with the variables `farm`, `flock` and `week`;
* presence of clinical signs with the variables `respiratory`, `diarrhoea`,
  `cns`, `malaise`, `leg_lesions` and `sudden_death`;
* AMU (presence / absence too) with the variables `amoxicillin_use` to
  `unknown_use`.

## Weeks inclusion

The week we are interested in are the weeks for which

* there is no clinical sign the current week and $x$ weeks before;
* there is no AMU $y$ weeks before;

Note here that the first point can apply to any set of clinical signs and that
the second point can apply to any set of antimicrobials. Here, we build the
function `filter_weeks()` that performs that filering. This function makes use
of the function `lagging()` defined below and that lags some variables of a data
frame that must have at least 3 columns named respectively `farm`, `flock` and
`week`:

```{r}
lagging <- function(df, var, lag) {
  require(magrittr)                                                              
  df %>%
    dplyr::select(!! c("farm", "flock", "week", var)) %>% 
    dplyr::mutate(week = week + lag) %>% 
    dplyr::rename_at(var, paste0, lag)
}
```

Let's try it:

```{r}
lapply(1:2, lagging, df = viparc, var = c("colistin_use", "oxytetracycline_use")) %>% 
  purrr::reduce(dplyr::full_join, c("farm", "flock", "week")) %>% 
  dplyr::left_join(viparc, ., c("farm", "flock", "week")) %>% 
  dplyr::select(farm, flock, week, dplyr::matches("colistin|oxytetracycline")) %>% 
  head(20)
```

It works as expected. Now we can define the `filter_weeks()` function that uses
the above-defined `lagging()` function:

```{r}
filter_weeks <- function(df, clinical_signs, antimicrobials, lcs, lam) {
  require(magrittr)
  
  df %>%
    dplyr::select(c(clinical_signs, antimicrobials)) %>% 
    is.na() %>% 
    any() %>% 
    `!`() %>% 
    stopifnot()
  
  df %>% 
    names() %>% 
    grepl("\\d$", .) %>% 
    any() %>% 
    `!`() %>% 
    stopifnot()
  
  flock_id <- c("farm", "flock", "week")
  
  lcs <- 1:lcs
  lam <- 1:lam
  
  vsel <- purrr::map2(list(lcs, lam),
                      list(clinical_signs, antimicrobials),
                      function(x, y) sapply(c("", x), function(z) paste0(y, z))) %>% 
    unlist() %>% 
    setdiff(antimicrobials)
  
  purrr::map2(list(lcs, lam),
              list(clinical_signs, antimicrobials),
              function(x, y) lapply(x, lagging, df = df, var = y)) %>% 
    unlist(FALSE) %>% 
    purrr::reduce(dplyr::left_join, flock_id) %>% 
    dplyr::left_join(viparc, ., flock_id) %>% 
    dplyr::mutate_at(dplyr::vars(dplyr::matches("\\d+$")), dplyr::coalesce, FALSE) %>% 
    dplyr::mutate(include = dplyr::select(., !! vsel) %>% rowSums() %>% as.logical() %>% `!`()) %>% 
    dplyr::select(-dplyr::matches("\\d+$"))
}
```

Note that the above pipeline assumes that

* there is no missing values in the `clinical_signs` or `antimicrobials` variables;
* there is no variable names ending with a digit.

Hence the 2 `stopifnot()` calls at the beginning of the function. Let's try it:

```{r}
filter_weeks(viparc, c("malaise", "diarrhoea"), c("colistin_use", "oxytetracycline_use"), 2, 2) %>% 
  dplyr::select(farm, flock, week, colistin_use, oxytetracycline_use, malaise, diarrhoea, include) %>% 
  head(20)
```

Seems to work as expected. Next section puts this weeks selection together with
the computation of an outcome, by defining the function `prepare_data()`.

## AMU input and clinical sign output

The following function is another use of the `lagging()` function in order to
generate the outcome variables in terms of clinical signs:

```{r}
make_output <- function(df, outcome, loc, name = "disease") {
  loc <- -(1:loc)
  vsel <- unlist(lapply(outcome, paste0, loc))
  flock_id <- c("farm", "flock", "week")
  lapply(loc, lagging, df = df, var = outcome) %>% 
    purrr::reduce(dplyr::left_join, flock_id) %>% 
    dplyr::left_join(df, ., flock_id) %>% 
    dplyr::mutate(!!name := dplyr::select(., dplyr::matches("-\\d+$")) %>% rowSums() %>% as.logical()) %>% 
    dplyr::select(-dplyr::matches("\\d+$"))
}
```

Let's try it:

```{r}
viparc[356:386, ] %>%
  make_output(c("malaise", "diarrhoea"), 2) %>% 
  dplyr::select(farm, flock, week, malaise, diarrhoea, disease) %>% 
  as.data.frame()
```

Seems to work as expected. Note the missing values at the end of the flocks too.
The following function makes the input variable:

```{r}
make_input <- function(df, antimicrobials) {
  dplyr::mutate(df, amu = dplyr::select(df, antimicrobials) %>% rowSums() %>% as.logical())
}
```

Let's try it:

```{r}
make_input(viparc, c("colistin_use", "oxytetracycline_use")) %>% 
  dplyr::select(farm, flock, week, colistin_use, oxytetracycline_use, amu)
```

Seems to work as expected.

## Optional: covariables

### AMU first week

```{r}
first_week <- function(df, antimicrobials, wk = 1) {
  df %>%
    dplyr::filter(week < wk + 1) %>% 
    dplyr::mutate(amu_first_week = dplyr::select(., antimicrobials) %>% rowSums() %>% as.logical()) %>% 
    dplyr::select(farm, flock, amu_first_week) %>% 
    dplyr::left_join(df, ., c("farm", "flock"))
}
```

Let's try it:

```{r}
viparc %>% 
  first_week(c("amoxicillin_use", "ampicillin_use")) %>% 
  dplyr::select(farm, flock, week, amoxicillin_use, ampicillin_use, amu_first_week)
```

and:

```{r}
viparc %>% 
  first_week(c("amoxicillin_use", "ampicillin_use")) %>% 
  dplyr::select(farm, flock, week, amoxicillin_use, ampicillin_use, amu_first_week) %>% 
  dplyr::filter(farm == "75-013")
```

Seems to work as expected.

### AMU after focal week

If one wants to compute a covariable accounting for AMU after the focal week,
that can be done as:

```{r}
viparc %>% make_output(c("amoxicillin_use", "ampicillin_use"), 2, "amu_use") %>% 
  dplyr::select(farm, flock, week, amoxicillin_use, ampicillin_use, amu_use) %>% 
  head(20)
```

## Examples of uses

Simple use of a Fisher exact test, without any co-variable:

```{r}
viparc %>% 
  filter_weeks(c("malaise", "diarrhoea"), c("colistin_use", "oxytetracycline_use"), 2, 2) %>% 
  make_input(c("colistin_use", "oxytetracycline_use")) %>% 
  make_output(c("malaise", "diarrhoea"), 2) %>% 
  dplyr::filter(include) %>% 
  dplyr::select(amu, disease) %>% 
  na.exclude() %T>% print() %$%
  table(amu, disease) %T>% print() %>% 
  fisher.test()
```

A logistic regression can equivalently be used:

```{r}
viparc %>% 
  filter_weeks(c("malaise", "diarrhoea"), c("colistin_use", "oxytetracycline_use"), 2, 2) %>% 
  make_input(c("colistin_use", "oxytetracycline_use")) %>% 
  make_output(c("malaise", "diarrhoea"), 2) %>% 
  dplyr::filter(include) %>% 
  dplyr::select(amu, disease) %>% 
  na.exclude() %T>% print() %>%
  glm(disease ~ amu, binomial, .) %>% 
  summary()
```

If one wants to consider (and correct for) covariables -- such as age, flock,
farm, AMU on the first week or AMU after the focal week --, the pipeline would
look like:

```{r}
show_summary <- function(x) print(summary(x))
viparc %>% 
  filter_weeks(c("malaise", "diarrhoea"), c("colistin_use", "oxytetracycline_use"), 2, 2) %>% 
  make_input(c("colistin_use", "oxytetracycline_use")) %>% 
  make_output(c("malaise", "diarrhoea"), 2) %>% 
  first_week(c("colistin_use", "oxytetracycline_use")) %>% 
  make_output(c("colistin_use", "oxytetracycline_use"), 2, "amu_use") %>% 
  dplyr::filter(include) %>% 
  dplyr::select(farm, flock, week, amu_first_week, amu_use, amu, disease) %>% 
  na.exclude() %T>% print() %>% 
  glm(disease ~ amu_first_week + amu_use + week + amu, binomial, .) %T>% show_summary() %>% 
  anova(test = "LRT")
```

Here, if one wanted to correct for potential farm and / or flock effect, he'd
have to consider mixed effect models (we'll explore that latter).